---
- name: Run pihole
  docker_container:
    name: pihole
    image: pihole/pihole:latest
    detach: true
    restart_policy: always
    ports:
      - "53:53/tcp"
      - "53:53/udp"
      - "67:67/udp"
      - "80:80/tcp"
    env:
      TZ: 'America/Chicago'
      WEBPASSWORD: "{{ pihole_webpass }}"
      VIRTUAL_HOST: "{{ dns_address }}"
    volumes:
      - './etc-pihole/:/etc/pihole/'
      - './etc-dnsmasq.d/:/etc/dnsmasq.d/'
    capabilities:
      - NET_ADMIN

- name: Make directory if DNE
  file:
    path: /opt/pihole
    state: directory
  become: true

- name: Create DNS file
  template:
    src: files/custom.list.j2
    dest: /opt/pihole/etc-pihole/custom.list
  become: true

- name: Ensure sqlite3 is installed
  apt:
    name: sqlite3
    update_cache: true
  become: true

